#!/bin/sh

tmpdir=""
PathsFile=""

# fix echo
echo () { printf %s\\n "$*" ; }

find_executables () {
    # throw errors to /dev/null we only want matches
    find "$HOME" -name 'th[0-9]*[0-9]\.exe' 2>/dev/null
}

# usage: create_runscript path name executable_name
create_runscript () {
    Path="$1"
    Name="$2"
    ExeN="$3"
cat << __SCRIPT__
#!/bin/sh

# runscript for touhou ${Name}

# go to executable directory
cd "$Path" || exit

# run executable
wine th${ExeN}.exe
__SCRIPT__
}

# usage: create_desktopfile path name
create_desktopfile () {
    Path="$1"
    Name="$2"
cat << __DESKTOP__
[Desktop Entry]
Type=Application
Terminal=false
Icon=$Path/Icon_th$Name.png
Exec=$HOME/.local/bin/touhou-$Name
Categories=Game;
Name=Touhou ~ $Name
__DESKTOP__
}

tmppath="/tmp/tuhustp"

if mkdir -p "$tmppath" ; then
    tmpdir="$tmppath"
else
    tmpdir="$HOME"
fi

PathsFile="${tmpdir}/PathsFound"

# search for executables from home directory
echo "searching for touhou executables"

find_executables > "$PathsFile"
echo "list of found touhou executables written to '$PathsFile'"

# number of games found saved to variable
NumPaths=$(wc -l "$PathsFile" | cut -d' ' -f1 )

# number of icons found saved to variable
IconPaths=$(find "$HOME" -name 'Icon_th[0-9]*[0-9]\.png' | wc -l)
if [ !  "$IconPaths" = "$NumPaths" ]; then
	echo "some games lack icons"
	LacksIcon=1
	# check if tool to create icons exists
	command -v extresso  > /dev/null && CanCreateIcon=1 || CanCreateIcon=0
	[ 1 = $CanCreateIcon ] && echo "missing icons will be created" || echo "missing icons can't be created please install icoutils and re-run"
else
	LacksIcon=0
fi

# start counter
NumLine=1
while [ $NumLine -le "$NumPaths" ]; do
	# cd to dir of nth game found
	cd "$(sed 's/th[0-9]*[0-9].exe$//;'$NumLine'q;d' "$PathsFile")" || exit

	# read the numbers from the exe filename
	TouhouNum=$(echo th*[!e].exe|cut -c 3-|head --bytes -5)

	# check if an additional patched exe exists
	if [ -f th"$TouhouNum"e.exe  ]; then
		# set the name of the additional patched exe for the run script
		TouhouNumE="${TouhouNum}e"
	else
		# set the name of the only exe for the run script
		TouhouNumE=$TouhouNum
	fi

	# create missing icons if the tools are avaible
	if [ ! -f Icon_th"$TouhouNum".png  ]; then
		if [ $LacksIcon = 1 ] && [ $CanCreateIcon = 1 ]; then
			echo "creating icon for th$TouhouNum"
			wrestool -x -t 14 th"$TouhouNum".exe > out.ico
			icotool -x -o . out.ico
			mv out*.png Icon_th"$TouhouNum".png
			rm out.ico
		fi
	fi

	CurrentDirPath="$(pwd)"
	echo "creating runscript for th$TouhouNum"
    create_runscript "$CurrentDirPath" "$TouhouNum" "$TouhouNumE" > "$HOME"/.local/bin/touhou-"$TouhouNum"
    chmod +x "$HOME"/.local/bin/touhou-"$TouhouNum"

	echo "creating launcher for th$TouhouNum"
    create_desktopfile "$CurrentDirPath" "$TouhouNum" > "$HOME"/.local/share/applications/th"$TouhouNum".desktop

	NumLine=$((NumLine + 1))
	cd "$HOME" || exit
done

cd "$HOME" || exit

rm "$PathsFile"

echo "finished"
